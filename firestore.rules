rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ===== CATEGORIES =====
    // Anyone can read categories
    match /categories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin can write (via backend)
    }
    
    // ===== PRODUCTS =====
    // Anyone can read products
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow write: if false; // Only admin can write (via backend)
    }
    
    // ===== USERS =====
    match /users/{userId} {
      // User can only read/write their own document
      allow read, write: if isOwner(userId);
      
      // ===== USER CART =====
      match /cart/{productId} {
        // User can only read/write their own cart
        allow read, write: if isOwner(userId);
      }
      
      // ===== USER ADDRESSES =====
      match /addresses/{addressId} {
        // User can only read/write their own addresses
        allow read, write: if isOwner(userId);
      }
      
      // ===== USER ORDERS =====
      match /orders/{orderId} {
        // User can only read their own orders
        allow read: if isOwner(userId);
        // User can only create orders for themselves
        allow create: if isOwner(userId) && request.resource.data.userId == userId;
        // User can only update their own orders (for cancellation)
        allow update: if isOwner(userId) && resource.data.userId == userId;
        allow delete: if false; // Orders cannot be deleted
      }
    }
    
    // ===== ORDERS (Global Collection) =====
    match /orders/{orderId} {
      // Only the order owner can read
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Only authenticated users can create orders
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Only the order owner can update (for cancellation)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if false; // Orders cannot be deleted
    }
  }
}
